require(MSImaging);
require(mzkit);
require(ggplot);

options(memory.load = "max");

setwd(@dir);

# let ions = read.csv( "./ions.xls", tsv = TRUE, row.names = NULL, check.names=FALSE);
let msi_data = open.mzpack("\\192.168.1.254\backup3\项目以外内容\2024\MEMI_test\3ul_0.8Mpa_RAW_20241021-Kidney-2\raw_0_0.mzPack");
let ions = [
    "318_11184"
"319_20340"
"320_25603"
"322_27168"
"324_28968"
"331_28430"
"332_33180"
"337_27130"
"339_29000"
"341_18594"
"344_27950"
"346_27168"
"348_28733"
"355_28430"
"357_29990"
"358_21430"
"358_30800"
"369_24020"
"369_35220"
"370_29520"
"372_22880"
"372_31080"
"373_23490"
"388_22310"
"393_24020"
"395_25580"
"396_31080"
"398_32650"
"400_34210"
"401_34200"
"403_28430"
"422_32411"
"424_34210"
"425_33900"
"426_35780"
"427_35760"
"428_37340"
"438_29801"
"441_24020"
"448_33976"
"454_29334"
"464_31366"
"466_32931"
"478_29334"
"480_30858"
"480_34483"
"482_32423"
"494_32464"
"496_33980"
"502_29044"
"502_32683"
"503_30109"
"505_31671"
"506_36048"
"508_37613"
"510_35539"
"518_32464"
"520_34029"
"522_35594"
"524_37110"
"534_29564"
"544_33980"
"554_28610"
"619_52720"
"657_48550"
"675_54353"
"689_55918"
"699_52030"
"701_55918"
"702_54319"
"702_56760"
"703_57490"
"704_52246"
"705_53090"
"706_53811"
"712_57940"
"714_50446"
"716_52246"
"716_55884"
"717_59048"
"718_53811"
"718_57449"
"720_55376"
"724_52520"
"725_53270"
"728_55884"
"729_56720"
"730_53811"
"731_54650"
"731_60620"
"733_56220"
"734_56940"
"735_56870"
"738_50446"
"738_54084"
"739_51508"
"740_52011"
"741_53073"
"741_56720"
"742_53576"
"743_54638"
"743_54650"
"744_55376"
"745_59850"
"746_56941"
"748_52520"
"748_58506"
"749_53280"
"750_53120"
"750_54080"
"752_54680"
"753_56720"
"754_52610"
"755_54650"
"756_54180"
"756_61450"
"757_56220"
"757_62178"
"758_55740"
"758_56940"
"759_57450"
"759_57780"
"759_63750"
"760_57310"
"760_58510"
"761_59020"
"761_59350"
"762_50446"
"762_60070"
"764_52010"
"765_52190"
"766_52610"
"766_57450"
"767_56980"
"768_55140"
"768_57810"
"768_59020"
"769_55320"
"769_59850"
"770_56706"
"771_57768"
"771_61420"
"772_58506"
"773_59350"
"774_54080"
"774_60071"
"778_57214"
"780_54180"
"780_58779"
"781_56220"
"782_56700"
"783_56470"
"783_57780"
"783_63508"
"784_58270"
"785_58090"
"785_59350"
"785_65308"
"786_60070"
"787_59600"
"787_66873"
"788_52011"
"788_55649"
"788_61640"
"789_61160"
"790_53570"
"790_55924"
"790_57210"
"792_55140"
"792_57810"
"792_58780"
"793_56200"
"793_59850"
"794_50966"
"794_59380"
"794_60580"
"796_61909"
"797_59333"
"798_59836"
"799_66873"
"801_68438"
"804_53039"
"804_54180"
"806_54604"
"806_56700"
"807_56530"
"807_57780"
"808_56169"
"808_58510"
"809_59330"
"810_57734"
"810_60070"
"811_59600"
"811_66630"
"812_54124"
"812_61400"
"812_61401"
"813_68440"
"814_55689"
"815_70003"
"818_50966"
"818_60344"
"820_52530"
"820_61909"
"822_63474"
"827_70003"
"830_56940"
"832_56169"
"832_58270"
"833_57790"
"834_57734"
"835_59600"
"836_54360"
"836_61700"
"837_62460"
"838_55926"
"838_62960"
"844_52531"
"846_52561"
"846_54096"
"848_55660"
"849_55190"
"856_56169"
"72_08075"
"76_03928"
"89_10735"
"90_05493"
"104_10697"
"106_04985"
"112_01592"
"114_06616"
"115_03742"
"116_07058"
"118_08623"
"120_06550"
"120_96634"
"123_05581"
"126_02190"
"130_04985"
"132_07680"
"132_10243"
"133_06082"
"133_09713"
"134_02700"
"134_04476"
"136_06181"
"137_04576"
"140_06823"
"146_16520"
"147_04160"
"147_07640"
"147_07646"
"148_00390"
"148_06040"
"148_07904"
"149_09371"
"150_05830"
"152_02206"
"152_05672"
"154_05873"
"154_08379"
"156_07673"
"159_02776"
"160_18080"
"162_11250"
"163_97780"
"166_08630"
"169_05788"
"169_98501"
"170_03263"
"175_00166"
"175_11900"
"185_03229"
"186_01631"
"188_07113"
"189_05135"
"189_12338"
"189_13458"
"190_04584"
"190_91460"
"198_08729"
"198_09740"
"201_08832"
"203_05133"
"203_15023"
"203_22300"
"204_12301"
"205_06835"
"205_09768"
"207_07645"
"216_06313"
"219_02654"
"219_03360"
"220_06929"
"227_11409"
"229_05851"
"229_15470"
"233_07797"
"233_12843"
"236_04319"
"248_14865"
"251_04221"
"255_13396"
"258_11980"
"263_23690"
"265_06974"
"269_08969"
"280_09208"
"281_24750"
"283_26320"
"296_06144"
"298_27410"
"300_28968"
"307_04392"
"308_09171"
"313_27430"
"317_11500"
];

print(ions);

for(let mz_i in tqdm(ions)) {
    let mz = as.numeric(gsub(mz_i,"_","."));
    let make_plot = function() {
        # load mzpack/imzML raw data file
        # and config ggplot data source driver 
        # as MSImaging data reader
        ggplot(msi_data, padding = "padding: 200px 600px 200px 250px;") 
        + geom_MSIbackground("TIC")
        # rendering of a single ion m/z
        # default color palette is Jet color set
        + geom_msimaging(mz = mz, tolerance = "da:0.01")        
        + geom_MSIfilters([            
            "knn_fill(3,0.65,random=false)"
            "soften()"
            "power(2)"
        ])
        + MSI_hqx(1)
        # add ggplot charting elements
        + ggtitle(`MSImaging of m/z ${mz}`)
        + labs(x = "Dimension(X)", y = "Dimension(Y)")
        + scale_x_continuous(labels = "F0")
        + scale_y_continuous(labels = "F0")
        ;
    }

    if (file.exists(`F:/All/${mz_i}.pdf`) && file.exists(`F:/All/${mz_i}.jpeg`)) {
        # skip
    } else {
        try({
            pdf(file = `F:/All/${mz_i}.pdf`, size = [4200, 2100], dpi = 300) {
                make_plot() 
            }

            bitmap(file = `F:/All/${mz_i}.jpeg`, size = [4200, 2100], dpi = 300) {
                make_plot() 
            }
        });
    }
}


